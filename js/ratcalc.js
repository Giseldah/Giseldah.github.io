var Penetrations,LevelCap,PlayerLvl,PlayerClass,PenIndex,ArmourType,CanBlock,GraphPerc,DblCalcDev=1e-8,PercTags=["crithit","devhit","critmagn","finesse","phydmg","tacdmg","outheal","resist","critdef","inheal","block","partblock","partblockmit","parry","partparry","partparrymit","evade","partevade","partevademit","phymit","ofmit","tacmit"],PercGroups={crithit:["devhit","critmagn"],tacdmg:["outheal"],block:["partblock","partblockmit"],parry:["partparry","partparrymit"],evade:["partevade","partevademit"],phymit:["ofmit"]},PenRatings={resist:"resistpen",block:"bpepen",partblock:"bpepen",partblockmit:"bpepen",parry:"bpepen",partparry:"bpepen",partparrymit:"bpepen",evade:"bpepen",partevade:"bpepen",partevademit:"bpepen",phymit:"armourpen",ofmit:"armourpenlow",tacmit:"armourpenlow"},ArmourTypes=["","light","medium","heavy"],DiffColorNeg="rgba(255, 170, 170, 0.3)",DiffColorZero="",DiffColorPos="rgba(170, 170, 255, 0.35)";function InitPenetrations(){Penetrations=[];for(var e,t,a,n,r,l,c,i,o,d=document.getElementById("pen-sel-list").getElementsByTagName("li"),u=0;u<d.length;u++)if(d[u].hasAttribute("data-penname")){if(t=d[u].getAttribute("data-penname"),a=d[u].getAttribute("data-pentype"),n=d[u].getAttribute("data-penlevel"),r=d[u].getAttribute("data-pentitle"),o=i=c=l=0,null!=n&&"onlvl"!=n)switch(e=Number(n),a){case"hidden2":c=l=CalcStat("TPenArmour",e,2),i=CalcStat("TPenBPE",e,2),o=CalcStat("TPenResist",e,2);break;case"hidden3":c=l=CalcStat("TPenArmour",e,3),i=CalcStat("TPenBPE",e,3),o=CalcStat("TPenResist",e,3);break;case"enhiii":c=l=CalcStat("T2PenArmour",e),i=CalcStat("T2PenBPE",e),o=CalcStat("T2PenResist",e)}"onlvl"!=n&&d[u].setAttribute("title",r.replace(/#bpepen/g,Math.round(i+DblCalcDev).toString()).replace(/#resistpen/g,Math.round(o+DblCalcDev).toString()).replace(/#armourpen/g,Math.round(l+DblCalcDev).toString())),Penetrations.push({name:t,type:a,level:n,title:r,armourpen:l,armourpenlow:c,bpepen:i,resistpen:o})}}function UpdatePenetrations(){for(var e,t,a,n,r,l,c,i,o=document.getElementById("pen-sel-list").getElementsByTagName("li"),d=0,u=0;u<o.length;u++)if(o[u].hasAttribute("data-penname")){if(o[u].getAttribute("data-penname"),t=o[u].getAttribute("data-pentype"),a=o[u].getAttribute("data-penlevel"),n=o[u].getAttribute("data-pentitle"),i=c=l=r=0,"onlvl"==a){switch(e=PlayerLvl,t){case"hidden2":l=r=CalcStat("TPenArmour",e,2),c=CalcStat("TPenBPE",e,2),i=CalcStat("TPenResist",e,2);break;case"hidden3":l=r=CalcStat("TPenArmour",e,3),c=CalcStat("TPenBPE",e,3),i=CalcStat("TPenResist",e,3);break;case"enhiii":l=r=CalcStat("T2PenArmour",e),c=CalcStat("T2PenBPE",e),i=CalcStat("T2PenResist",e)}o[u].setAttribute("title",n.replace(/#bpepen/g,Math.round(c+DblCalcDev).toString()).replace(/#resistpen/g,Math.round(i+DblCalcDev).toString()).replace(/#armourpen/g,Math.round(r+DblCalcDev).toString())),Penetrations[d].armourpen=r,Penetrations[d].armourpenlow=l,Penetrations[d].bpepen=c,Penetrations[d].resistpen=i}d++}}function ProcessLockedBtn(e){var t=e.id.replace("lockedbtn","");e.style.display="none",document.getElementById(t+"unlockedbtn").style.display="block",PercGroups[t].forEach(function(e){document.getElementById(e+"currrat").disabled=!1,UpdatePerc(e)})}function ProcessUnlockedBtn(e){var t=e.id.replace("unlockedbtn","");e.style.display="none",document.getElementById(t+"lockedbtn").style.display="block",PercGroups[t].forEach(function(e){document.getElementById(e+"currrat").disabled=!0,document.getElementById(e+"currrat").value=document.getElementById(t+"currrat").value,UpdatePerc(e)})}function ProcessCurrRat(t){var e=t.id.replace("currrat","");CorrectCurrRat(e),UpdateCurrPerc(e),UpdateRatDiff(e),void 0!==PercGroups[e]&&"none"!=document.getElementById(e+"lockedbtn").style.display&&PercGroups[e].forEach(function(e){document.getElementById(e+"currrat").value=t.value,UpdateCurrPerc(e),UpdateRatDiff(e),UpdateGraph(e)}),UpdateGraph(e)}function CorrectCurrRat(e){var t,a=document.getElementById(e+"currrat");a.disabled||(t=a.value.trim(),e=Number(t),(t=(e=isNaN(e)?0:Math.max(Math.round(e+DblCalcDev),0)).toString())!=a.value&&(a.value=t))}function UpdateCurrPerc(e){var t,a,n,r=document.getElementById(e+"currperc");r.disabled||(t=document.getElementById(e+"currrat"),a=ReplaceArmourType(e),n=CalcStat(a+"PBonus",PlayerLvl),e=void 0===(e=PenRatings[e])?0:Penetrations[PenIndex][e],n=(CalcStat(a+"PRatP",PlayerLvl,Number(t.value)+e)+2e-4+n+DblCalcDev).toFixed(1).toString(),r.innerHTML=n+(n.includes(".")?"%":".0%"))}function ProcessTargPerc(e){e=e.id.replace("targperc","");CorrectTargPerc(e),UpdateTargRat(e),UpdateRatDiff(e),UpdateGraph(e)}function CorrectTargPerc(e){var t,a,n,r=document.getElementById(e+"targperc");r.disabled||(t=ReplaceArmourType(e),a=CalcStat(t+"PBonus",PlayerLvl),n=r.value.trim().replace("%",""),e=Number(n),n=(e=isNaN(e)?a:Math.min(Math.max(e.toFixed(1),a),(CalcStat(t+"PratPCap",PlayerLvl)+a+DblCalcDev).toFixed(1))).toString(),(n+=n.includes(".")?"%":".0%")!=r.value&&(r.value=n))}function UpdateTargRat(e){var t,a,n,r=document.getElementById(e+"targrat");r.disabled||(t=document.getElementById(e+"targperc"),a=ReplaceArmourType(e),n=CalcStat(a+"PBonus",PlayerLvl),e=void 0===(e=PenRatings[e])?0:Penetrations[PenIndex][e],e=Math.ceil(CalcStat(a+"PPRat",PlayerLvl,Number(t.value.replace("%",""))-n)-e-DblCalcDev),r.innerHTML=e)}function UpdateRatDiff(e){var t,a=document.getElementById(e+"ratdiff");a.disabled||(t=document.getElementById(e+"currrat"),e=document.getElementById(e+"targrat"),e=Number(t.value)-Number(e.innerHTML),a.innerHTML=e,a.style.backgroundColor=0==e?DiffColorZero:e<0?DiffColorNeg:DiffColorPos)}function ReplaceArmourType(e){return"phymit"==e||"ofmit"==e||"tacmit"==e?"Mit"+ArmourTypes[ArmourType]:e}function MakeSelection(e){var t=document.getElementById("popup"),a=document.getElementById("pu-sel-"+e);t.hidden||!t.hidden&&a.hidden?(t.hidden=!0,document.getElementById("pu-sel-class").hidden=!0,document.getElementById("pu-sel-level").hidden=!0,document.getElementById("pu-sel-pen").hidden=!0,document.getElementById("pu-sel-graph").hidden=!0,a.hidden=!1,"class"==e?(t.style.left=(Number(document.getElementById("calc").offsetLeft)+62).toString()+"px",t.style.top=(Number(document.getElementById("calc").offsetTop)+67).toString()+"px",t.hidden=!1):"level"==e?(t.style.left=(Number(document.getElementById("calc").offsetLeft)+68).toString()+"px",t.style.top=(Number(document.getElementById("calc").offsetTop)+67).toString()+"px",t.hidden=!1,document.getElementById("level-sel-range").min=1,document.getElementById("level-sel-range").max=LevelCap,document.getElementById("level-sel-range").value=PlayerLvl):"pen"==e?(t.style.left=(Number(document.getElementById("calc").offsetLeft)+367).toString()+"px",t.style.top=(Number(document.getElementById("calc").offsetTop)+67).toString()+"px",t.hidden=!1,t.style.left=(621-Number(t.offsetWidth)).toString()+"px"):"graph"==e&&(t.style.left=(Number(document.getElementById("graph").offsetLeft)+62).toString()+"px",t.style.top=(Number(document.getElementById("graph").offsetTop)+67).toString()+"px",t.hidden=!1)):(t.hidden=!0,a.hidden=!0)}function CloseSelection(){document.getElementById("popup").hidden=!0,document.getElementById("pu-sel-class").hidden=!0,document.getElementById("pu-sel-level").hidden=!0,document.getElementById("pu-sel-pen").hidden=!0,document.getElementById("pu-sel-graph").hidden=!0}function SelectClass(e){PlayerClass=e,document.getElementById("popup").hidden=!0,document.getElementById("pu-sel-class").hidden=!0,ChangeClass(),PercTags.forEach(UpdatePerc)}function SelectLevel(e){PlayerLvl=Number(e),document.getElementById("popup").hidden=!0,document.getElementById("pu-sel-level").hidden=!0,ChangeLevel(),PercTags.forEach(UpdatePerc)}function LvlRangeUpdate(e){document.getElementById("popup").hidden||(document.getElementById("level-number").innerHTML=e)}function SelectPen(t){PenIndex=Penetrations.findIndex(function(e){return e.name==t}),document.getElementById("popup").hidden=!0,document.getElementById("pu-sel-pen").hidden=!0,ChangePen(),PercTags.forEach(UpdatePerc)}function SelectGraph(e){GraphPerc=e,document.getElementById("popup").hidden=!0,document.getElementById("pu-sel-graph").hidden=!0,ChangeGraph()}function ChangeClass(){for(var e=document.getElementById("class-sel-list").getElementsByTagName("li"),t=0;t<e.length;t++)if(e[t].getAttribute("data-classname")==PlayerClass){document.getElementById("class-symb").setAttribute("src",e[t].getElementsByTagName("img")[0].getAttribute("src")),document.getElementById("class-name").innerHTML=e[t].getElementsByTagName("div")[0].innerHTML;break}ArmourType=CalcStat(PlayerClass+"CDArmourType",PlayerLvl),CanBlock!=(CanBlock=0<CalcStat(PlayerClass+"CDCanBlock",PlayerLvl))&&(CanBlock?EnablePercGroup:DisablePercGroup)("block")}function ChangeLevel(){document.getElementById("level-number").innerHTML=PlayerLvl.toString(),ArmourType=CalcStat(PlayerClass+"CDArmourType",PlayerLvl),CanBlock!=(CanBlock=0<CalcStat(PlayerClass+"CDCanBlock",PlayerLvl))&&(CanBlock?EnablePercGroup:DisablePercGroup)("block"),UpdatePenetrations()}function ChangePen(){for(var e=document.getElementById("pen-sel-list").getElementsByTagName("li"),t=0;t<e.length;t++)if(e[t].getAttribute("data-penname")==Penetrations[PenIndex].name){var a=e[t].firstElementChild;document.getElementById("pen-desc").innerHTML=a.getElementsByTagName("p")[0].innerHTML,document.getElementById("pen-slot").setAttribute("src",a.getElementsByTagName("img")[0].getAttribute("src"));break}}function ChangeGraph(){for(var e=document.getElementById("graph-sel-list").getElementsByTagName("li"),t=0;t<e.length;t++)if(e[t].getAttribute("data-percname")==GraphPerc){var a=e[t].firstElementChild;document.getElementById("perc-deco").setAttribute("src",a.getElementsByTagName("img")[0].getAttribute("src")),document.getElementById("perc-name").innerHTML=a.getElementsByTagName("p")[0].innerHTML;break}graphconfig.options.title.text=document.getElementById("perc-name").innerHTML,UpdateGraphData(),window.myLine.update()}function UpdatePerc(e){UpdateCurrPerc(e),CorrectTargPerc(e),UpdateTargRat(e),UpdateRatDiff(e),UpdateGraph(e)}function DisablePercGroup(e){function t(e){document.getElementById(e+"lbl").disabled=!0,document.getElementById(e+"currrat").disabled=!0,document.getElementById(e+"currrat").value=0,document.getElementById(e+"currperc").disabled=!0,document.getElementById(e+"currperc").innerHTML="-",document.getElementById(e+"targperc").disabled=!0,document.getElementById(e+"targperc").value=0,document.getElementById(e+"targrat").disabled=!0,document.getElementById(e+"targrat").innerHTML="-",document.getElementById(e+"ratdiff").disabled=!0,document.getElementById(e+"ratdiff").innerHTML="-",document.getElementById(e+"ratdiff").style.backgroundColor=DiffColorZero}void 0!==PercGroups[e]&&(document.getElementById(e+"lockedbtn").style.display="none",document.getElementById(e+"unlockedbtn").style.display="none",t(e),PercGroups[e].forEach(t))}function EnablePercGroup(e){function t(e){document.getElementById(e+"lbl").disabled=!1,document.getElementById(e+"currrat").disabled=!1,document.getElementById(e+"currrat").value="0",document.getElementById(e+"currperc").disabled=!1,document.getElementById(e+"targperc").disabled=!1,document.getElementById(e+"targperc").value="999",document.getElementById(e+"targrat").disabled=!1,document.getElementById(e+"ratdiff").disabled=!1,UpdatePerc(e)}void 0!==PercGroups[e]&&(document.getElementById(e+"lockedbtn").style.display="block",t(e),PercGroups[e].forEach(t),ProcessUnlockedBtn(document.getElementById(e+"unlockedbtn")))}var NxScale,NyScale,GraphInit=!(window.onload=function(){PlayerClass=document.getElementById("class-sel-list").firstElementChild.getAttribute("data-classname"),LevelCap=CalcStat("LevelCap",0),PlayerLvl=LevelCap,InitPenetrations(),PenIndex=0,GraphPerc=document.getElementById("graph-sel-list").firstElementChild.getAttribute("data-percname"),ChangeClass(),ChangeLevel(),ChangePen(),PercTags.forEach(function(e){void 0!==PercGroups[e]&&"block"!=e&&ProcessUnlockedBtn(document.getElementById(e+"unlockedbtn"));document.getElementById(e+"currrat").value="0",UpdateCurrPerc(e),document.getElementById(e+"targperc").value="999",CorrectTargPerc(e),UpdateTargRat(e),UpdateRatDiff(e)}),InitGraph(),document.getElementById("cs-version").innerHTML="v"+CalcStat("-Version",0)}),GraphPoints=1001,Interval0=0,Interval1=0,Fix1={r:0,p:0},Interval2=0,Fix2={r:0,p:0},Interval3=GraphPoints-1,GraphType=2,graphconfig={type:"line",data:{datasets:[{label:" ",backgroundColor:"grey",borderColor:"grey",borderWidth:3,fill:!1},{label:" ",backgroundColor:"red",borderColor:"red",borderWidth:3,fill:!1},{label:" ",backgroundColor:"blue",borderColor:"blue",borderWidth:5,fill:!1},{label:" ",backgroundColor:"green",borderColor:"green",borderWidth:5,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,title:{display:!0,text:" ",fontSize:18},tooltips:{mode:"nearest",intersect:!1,callbacks:{title:function(e,t){switch(e[0].index){case Interval1:return Fix1.r.toString();case Interval2:if(GraphType<=2)return Fix2.r.toString();default:return RoundDbl(t.labels[e[0].index],1)}},label:function(e,t){switch(e.index){case Interval1:if(3==e.datasetIndex)return Fix1.p+"%";break;case Interval2:if(1==GraphType&&2==e.datasetIndex||2==GraphType&&1==e.datasetIndex)return Fix2.p+"%";if(3!=GraphType)break;default:return RoundDbl(e.value,2)+"%"}}}},elements:{point:{radius:0}},scales:{x:{display:!0,min:0,scaleLabel:{display:!0,labelString:" "},ticks:{major:{enabled:!0},fontSize:function(e){return e.tick.major?14:0},callback:function(e,t,a){return RoundDbl(e,0).toString()},maxRotation:0,padding:5},afterBuildTicks:function(e){const t=e.ticks;for(let e=0;e<t.length;e++)t[e].major=t[e].value/NxScale.getTickSpacing()==Math.round(t[e].value/NxScale.getTickSpacing());e.ticks=t},gridLines:{color:function(e){return e.tick.major?e.tick.value?"grey":"black":"lightgrey"},lineWidth:function(e){return!e.tick.major||e.tick.value?1:2},drawTicks:!1},type:"linear"},y:{beginAtZero:!0,display:!0,scaleLabel:{display:!0,labelString:" "},ticks:{major:{enabled:!0},fontSize:function(e){return e.tick.major?14:0},callback:function(e,t,a){return e+"%"},padding:5},afterBuildTicks:function(e){const t=e.ticks;for(let e=0;e<t.length;e++)t[e].major=t[e].value/NyScale.getTickSpacing()==Math.round(t[e].value/NyScale.getTickSpacing());e.ticks=t},gridLines:{color:function(e){return e.tick.major?e.tick.value?"grey":"black":"lightgrey"},lineWidth:function(e){return!e.tick.major||e.tick.value?1:2},drawTicks:!1},type:"linear"}}}};function InitGraph(){for(var e=document.getElementById("graph-sel-list").getElementsByTagName("li"),t=0;t<e.length;t++)if(e[t].getAttribute("data-percname")==GraphPerc){var a=e[t].firstElementChild;document.getElementById("perc-deco").setAttribute("src",a.getElementsByTagName("img")[0].getAttribute("src")),document.getElementById("perc-name").innerHTML=a.getElementsByTagName("p")[0].innerHTML;break}var n=document.getElementById("graphcontainer");graphconfig.data.datasets[0].label=n.getAttribute("data-lblremaining"),graphconfig.data.datasets[1].label=n.getAttribute("data-lblundertarget"),graphconfig.data.datasets[2].label=n.getAttribute("data-lblabovetarget"),graphconfig.data.datasets[3].label=n.getAttribute("data-lblcurrent"),graphconfig.options.scales.x.scaleLabel.labelString=n.getAttribute("data-lblrating"),graphconfig.options.scales.y.scaleLabel.labelString=n.getAttribute("data-lblperc"),NxScale=new NiceScale(0,100,9),NyScale=new NiceScale(0,100,9),GraphInit=!0,UpdateGraphData(),Chart.defaults.fontSize=14,Chart.defaults.fontColor="black",window.myLine=new Chart(document.getElementById("graphcanvas").getContext("2d"),graphconfig)}function UpdateGraph(e){e==GraphPerc&&GraphInit&&(UpdateGraphData(),window.myLine.update())}function UpdateGraphData(){if(GraphInit){var e,t=GraphPerc,a=Number(document.getElementById(t+"currrat").value),n=Number(document.getElementById(t+"currperc").innerHTML.replace("%","").replace("-","")),r=Number(document.getElementById(t+"targperc").value.replace("%","").replace("-","")),l=Number(document.getElementById(t+"targrat").innerHTML),c=ReplaceArmourType(t),i=CalcStat(c+"PBonus",PlayerLvl),o=PenRatings[t],d=void 0===o?0:Penetrations[PenIndex][o],t=Math.ceil(CalcStat(c+"PRatPCapR",PlayerLvl)-d-DblCalcDev),o=Math.ceil(CalcStat(c+"PRatPCap",PlayerLvl)+i-DblCalcDev);graphconfig.options.title.text=document.getElementById("perc-name").innerHTML+document.getElementById("graphcontainer").getAttribute("data-lblcapinfo").replace("#capperc",o).replace("#caprat",t),NxScale.setMinMaxPoints(0,a<=t?1.05*t:1.02*a),e=(t=NxScale.getNiceUpperBound())/(GraphPoints-1),NyScale.setMinMaxPoints(0,o),o=NyScale.getNiceUpperBound(),GraphType=l<a?(Interval1=Math.round(l/e+DblCalcDev),Fix1.r=l,Fix1.p=r,Interval2=Math.round(a/e+DblCalcDev),Fix2.r=a,Fix2.p=n,Interval3=GraphPoints-1,1):a<l?(Interval1=Math.round(a/e+DblCalcDev),Fix1.r=a,Fix1.p=n,Interval2=Math.round(l/e+DblCalcDev),Fix2.r=l,Fix2.p=r,Interval3=GraphPoints-1,2):(Interval1=Math.round(a/e+DblCalcDev),Fix1.r=a,Fix1.p=n,Interval2=GraphPoints-1,3);for(var u,p,s=[],m=[],g=[],y=[],h=[],b=0;b<GraphPoints;b++)switch(u=b*e,s.push(u),p=i+CalcStat(c+"PRatP",PlayerLvl,u+d),GraphType){case 1:h.push(Interval0<=b&&b<=Interval1?p:NaN),y.push(Interval1<=b&&b<=Interval2?p:NaN),m.push(Interval2<=b&&b<=Interval3?p:NaN),g.push(NaN);break;case 2:h.push(Interval0<=b&&b<=Interval1?p:NaN),g.push(Interval1<=b&&b<=Interval2?p:NaN),m.push(Interval2<=b&&b<=Interval3?p:NaN),y.push(NaN);break;case 3:h.push(Interval0<=b&&b<=Interval1?p:NaN),m.push(Interval1<=b&&b<=Interval2?p:NaN),g.push(NaN),y.push(NaN)}graphconfig.data.labels=s,graphconfig.data.datasets[0].data=m,graphconfig.data.datasets[1].data=g,graphconfig.data.datasets[2].data=y,graphconfig.data.datasets[3].data=h,graphconfig.options.scales.x.suggestedMax=t,graphconfig.options.scales.x.ticks.maxTicksLimit=999,graphconfig.options.scales.x.ticks.stepSize=NxScale.getTickSpacing()/(8<=t/NxScale.getTickSpacing()?5:10),graphconfig.options.scales.y.suggestedMax=o,graphconfig.options.scales.y.ticks.maxTicksLimit=999,graphconfig.options.scales.y.ticks.stepSize=NyScale.getTickSpacing()/(6<=o/NyScale.getTickSpacing()?5:10)}}function NiceScale(e,t,a){var n,r,l,c,i=e,o=t,d=a||10;function u(){r=p(o-i,!1),n=p(r/(d-1),!0),l=Math.floor(i/n)*n,c=Math.ceil(o/n)*n}function p(e,t){var a=Math.floor(Math.log10(e)),e=e/Math.pow(10,a),e=t?e<1.5?1:e<3?2:e<7?5:10:e<=1?1:e<=2?2:e<=5?5:10;return e*Math.pow(10,a)}u(),this.setMaxTicks=function(e){d=e,u()},this.getNiceUpperBound=function(){return c},this.getNiceLowerBound=function(){return l},this.getTickSpacing=function(){return n},this.setMinMaxPoints=function(e,t){i=e,o=t,u()}}function ShowNotes(){document.getElementById("notes").hidden=!1,document.getElementById("notes-text").scrollTop=0}function CloseNotes(){document.getElementById("notes").hidden=!0}